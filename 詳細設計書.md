1. システム全体像
1.1 アーキテクチャ

フロント：Next.js（SSG/SSR混在、App Router）、認証状態はCookie（HttpOnly, Secure, SameSite=Lax）。

API：FastAPI、JWTを発行（署名鍵はKMS管理）、RLSによりテナント強制。

DB：PostgreSQL（RLS・行レベルセキュリティ、PG bouncerで接続プール）。

キャッシュ/ジョブ：Redis（セッション/レート制限/キュージョブ）。

ストレージ：S3互換（ファイル添付・エクスポート）。

課金：Stripe（顧客＝テナント、Seats/プラン単位）。

ログ/監視：OpenTelemetry（Trace/Metric/Log）、アラート=エラー率・p95・課金失敗。

メール：SES/SendGrid（検証・アクティベーション・リマインド）。

IaC：Terraform（最小でも環境差分をコード化）。

1.2 マルチテナント方式（選定）

行レベル分離（Single DB, Shared Schema, tenant_id列）＋Postgres RLS

利点：コスト最小・運用容易・スキーマ管理が単一で速い。

補強：SET app.current_tenant（ロール変数）＋RLSポリシーで誤取得を物理的に防止。

代替：スキーマ分離/DB分離は顧客規模拡大時のエンタープライズ向けオプションとしてロードマップ化。

2. ドメインモデル
2.1 エンティティ（最小MVP）

Tenant：組織（会社）

User：ユーザー（所属テナント、多対1）

Account(顧客)：会社 or 個人顧客

Contact(担当者)：顧客の人物

Deal(商談)：パイプライン・ステージ・金額・確度

Activity/Note(メモ)：時系列メモ、通話/面談/メールの記録

Task：期限・担当・状態

CustomFieldDefinition / CustomFieldValue：業種別カスタム項目

Attachment：S3ファイル

AuditLog：操作監査

Subscription：Stripe連携（プラン・席数）

2.2 主要テーブル定義（要約）

tenants

id (uuid PK) / name / slug / created_at

users

id (uuid PK) / tenant_id (FK) / email (uniq per tenant) / password_hash / role(OWNER/ADMIN/MEMBER/VIEWER)/status/created_at

accounts

id (uuid) / tenant_id / name / industry / website / owner_user_id / created_at / updated_at

contacts

id (uuid) / tenant_id / account_id / first_name / last_name / email / phone / created_at

deals

id (uuid) / tenant_id / account_id / title / amount(decimal) / currency / stage(enum:New,Qualify,Proposal,Won,Lost) / probability / owner_user_id / expected_close_date / created_at / updated_at

notes

id / tenant_id / entity_type(account|contact|deal) / entity_id / body(text) / created_by / created_at

tasks

id / tenant_id / title / entity_type / entity_id / assignee_user_id / due_date / status(open|done) / priority / created_at

custom_field_definitions

id / tenant_id / entity_type / key / label / type(text|number|date|select|bool) / options(jsonb) / required / unique / created_at

custom_field_values

id / tenant_id / entity_type / entity_id / field_id / value(jsonb) / created_at

attachments

id / tenant_id / entity_type / entity_id / filename / content_type / size / s3_key / created_by / created_at

audit_logs

id / tenant_id / actor_user_id / action / entity_type / entity_id / ip / ua / diff(jsonb) / created_at

subscriptions

id / tenant_id / stripe_customer_id / stripe_subscription_id / plan / seats / status / current_period_end

インデックス・制約（抜粋）

UNIQUE(tenant_id, users.email)

INDEX(deals.tenant_id, stage, owner_user_id)（リスト画面高速化）

GIN(custom_field_values.value)（jsonb検索）

すべての主テーブルに tenant_id NOT NULL、FKは ON DELETE CASCADE 方針。

3. テナンシーとセキュリティ
3.1 RLS（Row Level Security）

有効化：ALTER TABLE <t> ENABLE ROW LEVEL SECURITY;

ポリシー例：

USING (tenant_id = current_setting('app.current_tenant')::uuid)

書込：同条件＋has_role()関数で権限制御。

接続時：API層で SET app.current_tenant = :tenant_id; を必ず実行（コネクションプール毎）。

3.2 認証/認可

認証：

メール＋パスワード（初期）、SAML/OAuthはエンタープライズで追加。

ログイン成功→短命セッションクッキー（サーバー側セッション or JWT＋Token Rotation）。

認可（RBAC）：

OWNER/ADMIN/MEMBER/VIEWER。

ルール：OWNER＝サブスク・メンバー管理、ADMIN＝設定/CF定義、MEMBER＝CRUD、VIEWER＝Read。

エンティティ所有者やチーム所有でさらに細分化可（ロードマップ）。

3.3 セキュリティ対策

2FA（TOTP）オプション。

レート制限：IP＋ユーザー＋テナント粒度でRedisにカウント。

監査ログ：重要操作（削除・権限変更・課金変更）。

ファイル：S3 Pre-signed URL（アップロード/ダウンロード）、アンチウイルススキャン（後続ジョブ）。

機微情報：秘密鍵/KMS、環境変数はSecret Manager。

脆弱性：Dependabot/Snyk、ベースイメージの定期リビルド。

4. API 設計（REST, 抜粋）

共通ヘッダ：X-Tenant: <slug or uuid>（ログイン後はサーバ側で紐付け可）
レスポンス：application/json、ページングは ?page, ?page_size または ?cursor。

Auth

POST /auth/login → セッション確立（Set-Cookie）、/auth/logout

POST /auth/forgot_password / POST /auth/reset_password

Accounts

GET /accounts（検索q,industry,owner）

POST /accounts / GET /accounts/{id} / PATCH /accounts/{id} / DELETE ...

Contacts

同上（/contacts）

Deals

GET /deals?stage=&owner=&sort=-updated_at

POST /deals（account_id,title,amount,currency,stage,probability）

PATCH /deals/{id}（ステージ遷移は監査に記録）

Notes/Tasks

POST /{entity}/{id}/notes / GET /{entity}/{id}/notes

POST /{entity}/{id}/tasks

Custom Fields

GET/POST /custom_fields/definitions?entity_type=deal

GET/PUT /custom_fields/values?entity_type=deal&entity_id=...

Attachments

POST /attachments/presign（S3 Pre-sign生成）

GET /attachments/{id}（一時URL返却）

Admin（テナント設定/ユーザー管理）

GET/POST /admin/users、PATCH /admin/users/{id}（role変更）

GET/POST /admin/settings（業種・通貨・ワークフロー）

Billing

POST /billing/checkout（Stripe セッション作成）

POST /billing/webhook（Stripe Webhook 受信、署名検証）

GET /billing/subscription（現在のプラン/Seats）

エラー規約：{ code, message, details? }、idempotency-key対応（POSTで再送防止）。

5. フロント設計（Next.js）
5.1 画面一覧（MVP）

認証：ログイン/招待/パスワードリセット。

ダッシュボード：今週のタスク、更新された商談、Won/Lost統計。

顧客(Account)一覧/詳細/編集。

商談(Deal)一覧/看板ビュー（Kanban）/詳細/編集。

連絡先(Contact)一覧/詳細/編集。

タスク一覧（担当者・期限フィルタ）。

管理：ユーザー管理、カスタムフィールド定義、課金ページ（プラン/Seats）。

5.2 UX方針

テーブルは列カスタム＋保存、フィルタのクエリストリング化。

フォームは汎用コンポーネント（標準＋CustomFieldレンダラ）。

オフライン考慮（楽観ロック＆差分同期は将来）。

i18n（ja/en）対応、通貨/日付ローカライズ。

6. ワークフロー・業種特化
6.1 カスタムフィールド

定義：管理画面でエンティティ別に追加。

バリデーション：typeに応じたスキーマ検証。

表示：一覧/詳細/検索に組み込み（jsonb_path_opsで索引）。

6.2 ステージ・自動化

商談ステージの業種別テンプレ（例：リード→見積→クロージング）。

自動化（将来）：ステージ変更トリガでタスク自動生成/通知。

7. 非機能要件
7.1 パフォーマンス

目標：p95 < 300ms（API）、初回TTFB < 200ms（SSR）。

N+1回避（JOIN/プリロード）、巨大一覧はカーソルページング。

インデックス設計＋部分索引（tenant_id＋頻出条件）。

7.2 可用性・バックアップ

可用性：SLA 99.9%（MVPはベストエフォート）。

バックアップ：DBスナップショット（毎日）、Point-in-Time(≤5分)。

復旧演習：四半期ごと。

7.3 監視

メトリクス：リクエスト数/レイテンシ/エラー率、ジョブ滞留、Stripe失敗数。

ログ：構造化JSON、PIIマスク、テナントID付与。

アラート：5xx 率>1%、p95>500ms、DB接続枯渇、課金Webhook失敗。

7.4 セキュリティ・コンプライアンス

OWASP ASVS 基本項目順守。

パスワード：Argon2id。（将来SSO/SAML）

データ保持ポリシー：退会後90日で自動削除（監査要件に応じ設定）。

DPA/利用規約/プライバシーポリシー整備。

8. 課金モデル（Stripe）

テナント＝Stripe Customer。

プラン：Starter（5ユーザーまで）、Team（20）、Pro（無制限）＋アドオン（ストレージ）。

課金単位：Seats＋月額。

機能制御：feature_flags（プラン別フラグ）をテナント設定に保持。

Webhook：invoice.payment_failed → 管理者通知、customer.subscription.updated → 機能/Seat反映。