# マルチテナントCRM MVP 実装計画（codex -a full-auto）

最終更新: 2025-09-13

## 概要
- 目的: マルチテナントCRMのMVPを12週間で実装し、基本CRUD/認証/RLS/課金/監査/添付/カスタムフィールドを提供。
- スコープ（MVPに含む）: Tenant, User, Account, Contact, Deal, Note/Task, CustomField, Attachment, AuditLog, Subscription。
- スコープ外（MVP後回し）: SSO/SAML、複雑なワークフロー/承認、課金バンドル最適化の細部。
- 根拠: 詳細設計書.md L33-L56, L134-L137, L300-L310

## リポジトリ/体制
- フロント: `apps/web`（Next.js 14, App Router, TypeScript）。
- API: `python-api`（FastAPI）を主バックエンドとして拡張（既存`python-api/main.py`から発展）。
- DB: PostgreSQL + RLS（PG Bouncer前提）。
- 共有基盤: Redis（セッション/レート制限/ジョブ）, S3（添付）, Stripe（決済）, OpenTelemetry（可観測性）。
- 根拠: 詳細設計書.md L4, L6, L8, L10-L16, L201-L206, L213-L219

## アーキテクチャ
- テナント解決/伝播
  - Web→APIへ`X-Tenant: <slug|uuid>`を必須送出。
  - APIでtenant_id解決後、DB接続ごとに`SET LOCAL app.current_tenant = :uuid`。
  - 接続プールはトランザクション単位設定でRLS整合性を担保。
- 認証/セッション
  - クッキーセッション（HttpOnly, Secure, SameSite=Lax）。将来的なJWTローテーションはオプション。
  - RBAC: OWNER/ADMIN/MEMBER/VIEWER。
- セキュリティ
  - 2FA(TOTP)、レート制限（Redis, IP+Userキー）、Argon2idパスワード、監査ログ（差分JSON）。
- 可観測性/性能
  - API p95 < 300ms、SSR TTFB < 200ms。OTelでTrace/Metric/Log、しきい値アラート。
- 根拠: 詳細設計書.md L162-L164, L118-L128, L4, L136, L138-L144, L148-L156, L294, L101, L16, L268-L269

## データベース/スキーマ
- 方式: Single DB / Shared Schema、全テーブル`tenant_id NOT NULL`、FKは`ON DELETE CASCADE`。
- テーブル順: tenants → users → accounts → contacts → deals → notes → tasks → custom_field_definitions → custom_field_values → attachments → audit_logs → subscriptions。
- 制約/索引:
  - UNIQUE(users.email)はテナント内ユニーク。
  - dealsの複合INDEX（tenant_id, stage, owner_user_id）。
  - custom_field_values.value(jsonb)にGIN、検索で`jsonb_path_ops`活用。
- RLS:
  - `ALTER TABLE <t> ENABLE ROW LEVEL SECURITY;`
  - `USING (tenant_id = current_setting('app.current_tenant')::uuid)`
  - `has_role()`関数で操作権限制御。
- 根拠: 詳細設計書.md L24, L57-L105, L109-L115, L251-L258, L120-L127

## API 設計（REST）
- 共通: `X-Tenant`必須、`Content-Type: application/json`、ページング（`page`/`page_size` or `cursor`）、POSTは`Idempotency-Key`対応、エラー形 `{code,message,details?}`。
- 認証: `POST /auth/login`(Set-Cookie), `/auth/logout`, `/auth/forgot_password`, `/auth/reset_password`。
- ドメインCRUD:
  - Accounts: `GET /accounts`（検索: name, industry, owner）、`POST/GET/{id}/PATCH/DELETE`。
  - Contacts: `GET/POST/...`。
  - Deals: `GET /deals?stage=&owner=&sort=-updated_at`、`POST`、`PATCH /deals/{id}`（ステージ変更は履歴/監査）。
  - Notes/Tasks: `POST /{entity}/{id}/notes|tasks`, `GET /{entity}/{id}/notes`。
- カスタムフィールド: `GET/POST /custom_fields/definitions`, `GET/PUT /custom_fields/values`。
- 添付: `POST /attachments/presign`（S3署名URL）、`GET /attachments/{id}`（短期URL）。
- 管理: `GET/POST /admin/users`, `PATCH /admin/users/{id}`（role変更）, `GET/POST /admin/settings`（フラグ/設定）。
- 課金: `POST /billing/checkout`, `POST /billing/webhook`, `GET /billing/subscription`。
- 根拠: 詳細設計書.md L162-L164, L221, L167-L219, L195-L206

## フロントエンド（Next.js）
- 画面（MVP）
  - 認証（ログイン/登録/パス再設定）
  - ダッシュボード（タスク/更新Deals/Won/Lost）
  - Account/Contact/Dealの一覧/詳細/編集、DealのKanban
  - タスク一覧（担当/期限/優先度）
  - 管理（ユーザー/RBAC、カスタムフィールド、課金）
- UX
  - 自動保存＋Undo、フォームコンポーネント（カスタムフィールド対応）、Inline Validation、i18n(ja/en)
  - ミドルウェアでテナント解決→API呼び出しに`X-Tenant`付与
- 根拠: 詳細設計書.md L223-L248, L162-L164

## 課金（Stripe）
- 単位: テナント=Stripe Customer。
- プラン: Starter(5ユーザー), Team(20), Pro(無制限) + Add-on(ストレージ)。
- 課金単位: Seatsベース。機能フラグは`feature_flags`としてテナント設定に保存。
- Webhook: `invoice.payment_failed`でアラート/状態更新、`customer.subscription.updated`でプラン/Seat同期。
- 根拠: 詳細設計書.md L300-L310

## 運用/信頼性
- SLO: API p95 < 300ms、SSR TTFB < 200ms。
- SLA: 99.9%（MVPはBest Effort）。
- バックアップ: スナップショット＋PITR（~5分）。
- アラート: 5xx > 1%、p95 > 500ms、DB接続異常、Webhook失敗。
- セキュリティ/保持: OWASP ASVS準拠、データ保持/削除90日、DPA/プライバシー。
- 根拠: 詳細設計書.md L268-L289, L274-L279, L290-L299

## 技術スタック（提案）
- API: FastAPI, SQLAlchemy 2.x, Alembic, Pydantic v2, `psycopg`/`asyncpg`, Argon2(`argon2-cffi`), 2FA(`pyotp`), Redis(`redis`), OTel（FastAPI用計装 + OTLP Exporter）, Stripe(`stripe`), S3/SES(`boto3`)
- Web: Next.js 14, TypeScript, Tailwind, `jose`, i18n(`next-intl`), E2E(Playwright)
- 共通: べき等性`idempotency_keys`テーブル（`hash(path+tenant+body)`+TTL）

## ディレクトリ構成（案）
- `python-api/`
  - `app/main.py`（起動）
  - `app/deps/`（テナント解決/RBAC）
  - `app/models/`, `app/schemas/`, `app/routers/`, `app/services/`, `app/repositories/`
  - `app/security/`（Argon2/2FA/JWTオプション）, `app/telemetry/`
  - `migrations/`（Alembic）
- `apps/web/`
  - `app/(auth|dashboard|accounts|deals|contacts|tasks|admin|billing)/`
  - `lib/api`, `lib/i18n`, `components/`
  - `middleware.ts`（`X-Tenant`付与）

## マイルストーン（12週間）
- M0 基盤/CI整備: pnpm/pytest/ruff/black、OTel雛形、`.env.example`更新（DoD: Lint/型ゼロ）。
- M1 DB/移行/RLS: スキーマ/Seed、`has_role()`実装、RLSテスト（DoD: すべて適用/検証）。
- M2 認証: ログイン/ログアウト/パス再設定、セッションCookie、Argon2（DoD: E2E通過）。
- M3 テナント/RBAC: `X-Tenant`→`SET LOCAL`、他テナント遮断テスト（DoD: 侵害0）。
- M4 Accounts/Contacts CRUD + 検索/ページング（DoD: OpenAPI/画面/テスト）。
- M5 Deals + Kanban + ステージ遷移（DoD: p95 < 300ms）。
- M6 Notes/Tasks + 監査ログ（DoD: 差分記録）。
- M7 Custom Fields（定義/値）+ 検索最適化（DoD: jsonb検索p95 < 300ms）。
- M8 添付（S3プリサイン）+ ウイルススキャン（DoD: 10MB/100MB検証）。
- M9 管理（ユーザー権限/設定/フラグ）（DoD: OWNER/ADMIN差分）。
- M10 課金（Checkout/Webhook/Subscription/Seats）（DoD: Stripe試験完了）。
- M11 監視/アラート/バックアップ/復旧演習（DoD: しきい値通知）。
- M12 セキュリティ（2FA/レート/保持方針/簡易ペンテスト）（DoD: ASVS項目クリア）。

## テスト/品質（DoD）
- カバレッジ >= 90%、Lint/型エラー0、契約テストでWeb↔API整合性を検証、性能しきい値をCIで自動検証（p95, TTFB）。
- コマンド（Windows/PowerShell）:
  - 依存: `pnpm install`
  - Web: `pnpm dev | pnpm build | pnpm start | pnpm lint | pnpm typecheck`
  - API: `pytest --cov=app --cov-fail-under=90`
- 根拠: AGENTS.md §3, §8、詳細設計書.md L268-L269

## リスクと対策
- RLS×PG Bouncer: 毎リクエストのトランザクション内`SET LOCAL`でtenant設定、プーリング方式を検証。
- POSTの重複作成: `Idempotency-Key`を保存/TTLで排他。
- JSONB肥大/性能: 必須/ユニーク制約の設計、`jsonb_path_ops`索引とVacuum監視。
- Webhook整合性: リトライ、署名検証、監査ログ、アラート。
- 根拠: 詳細設計書.md L118-L128, L221, L251-L258, L213-L219, L282-L289

## 直近のNext Actions
1. `python-api`に基盤パッケージ追加（SQLAlchemy/Alembic/Pydantic/psycopg/argon2/redis/stripe/opentelemetry/boto3）と設定雛形。
2. マイグレーション初期化＋主要テーブル/制約/索引＋RLSポリシ＋`has_role()`を実装。
3. APIに`X-Tenant`ミドルウェア、セッションCookie認証、RBACデコレータを実装。
4. WebにAPIクライアントと`X-Tenant`付与、Auth/Accounts/Dealsの画面スケルトンを配置。
5. CI（lint/typecheck/test/coverage）とメトリクス送信（OTLP）を有効化。

---

## 参照/根拠
- 設計: `C:\\Users\\masan\\Desktop\\new-service-20250913\\詳細設計書.md`
  - アーキテクチャ: L4-L21
  - データモデル/制約: L57-L115, L109-L114
  - RLS/セキュリティ: L118-L156, L294
  - API仕様: L160-L221
  - フロント/UX: L223-L248
  - カスタムフィールド/検索: L251-L258
  - 性能/運用/アラート: L268-L289
  - 課金: L300-L310
- リポジトリ構成: `apps/web/`, `python-api/`, `node-api/`（ローカル確認）

